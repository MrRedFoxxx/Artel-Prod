<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artel Prod. - Админ панель</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-container {
            background-color: #111;
            min-height: calc(100vh - 160px);
            padding: 2rem;
        }
        
        .admin-card {
            background-color: #222;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th, .admin-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        
        .admin-table th {
            background-color: #333;
            font-weight: 600;
        }
        
        .admin-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .admin-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #fff;
            color: #000;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #ddd;
        }
        
        .btn-danger {
            background-color: #ff4444;
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            background-color: #cc0000;
        }
        
        .btn-success {
            background-color: #00C851;
            color: white;
            border: none;
        }
        
        .btn-success:hover {
            background-color: #007E33;
        }
        
        .admin-form-input {
            background-color: #333;
            border: 1px solid #444;
            color: white;
            padding: 0.75rem;
            border-radius: 0.25rem;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .admin-form-input:focus {
            outline: none;
            border-color: #666;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid #444;
            margin-bottom: 1.5rem;
        }
        
        .admin-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .admin-tab.active {
            border-bottom-color: #fff;
            font-weight: 600;
        }
        
        .admin-tab:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: rgba(0, 200, 81, 0.2);
            color: #00C851;
        }
        
        .status-pending {
            background-color: rgba(255, 193, 7, 0.2);
            color: #FFC107;
        }
        
        .status-banned {
            background-color: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        .page-item {
            margin: 0 0.25rem;
        }
        
        .page-link {
            display: block;
            padding: 0.5rem 0.75rem;
            background-color: #333;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        
        .page-link:hover {
            background-color: #444;
        }
        
        .page-link.active {
            background-color: #fff;
            color: #000;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <div class="max-w-screen-2xl mx-auto">
        <!-- Header (сохранен из оригинального кода) -->
        <header class="flex justify-between items-center px-4 md:px-12 lg:px-24 bg-black shadow-lg relative z-50">
            <a href="/index.html"><img src="assets/Logo.png" alt="Логотип" class="w-48 h-28 object-cover hover-scale"></a>
            
            <nav class="hidden md:flex gap-8">
                <div class="dropdown">
                    <button class="font-bold text-lg hover:text-gray-300 transition focus:outline-none">ПОРТФОЛИО</button>
                </div>
                <a href="/Uslugi.html" class="font-bold text-lg hover:text-gray-300 transition">УСЛУГИ</a>
                <a href="/Blog-news.html" class="font-bold text-lg hover:text-gray-300 transition">БЛОГ</a>
                <span class="font-bold text-lg text-gray-300">КУРС</span>
            </nav>
            
            <div class="hidden md:flex items-center">
                <span class="font-normal text-xl">+7 980 678 20 93</span>
                <div class="flex ml-7 gap-4">
                    <a href="https://t.me/zarokmanager" class="text-white hover:text-blue-400 transition">
                        <i class="fab fa-telegram text-5xl"></i>
                    </a>
                    <a href="https://wa.me/79806782093?text=%D0%97%D0%B4%D1%80%D0%B0%D0%B2%D1%81%D1%82%D0%B2%D1%83%D0%B9%D1%82%D0%B5!%20%F0%9F%91%8B%20%D0%AF%20%D1%85%D0%BE%D1%87%D1%83%20%D1%81%D0%B4%D0%B5%D0%BB%D0%B0%D1%82%D1%8C%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7..." class="text-white hover:text-green-400 transition">
                        <i class="fab fa-whatsapp text-5xl"></i>
                    </a>
                </div>
            </div>
            
            <button class="md:hidden text-white">
                <i class="fas fa-bars text-3xl"></i>
            </button>
        </header>

        <!-- Админ панель -->
        <div class="admin-container px-4 md:px-12 lg:px-24">
            <h1 class="text-4xl font-bold mb-8">Административная панель</h1>
            
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="users">Пользователи</div>
                <div class="admin-tab" data-tab="videos">Видео</div>
                <div class="admin-tab" data-tab="photo-albums">Фотоальбомы</div>
                <div class="admin-tab" data-tab="stats">Статистика</div>
            </div>
            
            <!-- Таблица пользователей -->
            <div class="tab-content active" id="users-tab">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Управление пользователями</h2>
                    <button class="admin-btn btn-primary">
                        <i class="fas fa-plus mr-2"></i> Добавить пользователя
                    </button>
                </div>
                
                <div class="admin-card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="relative w-64">
                            <input type="text" placeholder="Поиск пользователей..." class="admin-form-input">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <div>
                            <select class="admin-form-input w-auto">
                                <option>Все статусы</option>
                                <option>Активные</option>
                                <option>Ожидают</option>
                                <option>Заблокированы</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Фамилия</th>
                                    <th>Логин</th>
                                    <th>Прогресс</th>
                                    <th>Дата регистрации</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <!-- Данные будут добавлены JavaScript -->
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Таблица видео -->
            <div class="tab-content" id="videos-tab">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Управление видео</h2>
                    <button class="admin-btn btn-primary" onclick="openVideoModal()">
                        <i class="fas fa-plus mr-2"></i> Добавить видео
                    </button>
                </div>
                
                <div class="admin-card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="relative w-64">
                            <input type="text" id="videoSearch" placeholder="Поиск видео..." class="admin-form-input">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <div>
                            <select id="videoTypeFilter" class="admin-form-input w-auto">
                                <option value="">Все типы</option>
                                <option value="Муд-видео">Муд-видео</option>
                                <option value="Сниппет">Сниппет</option>
                                <option value="Акустик-видео">Акустик-видео</option>
                                <option value="Подкаст">Подкаст</option>
                                <option value="Рекламный Reels">Рекламный Reels</option>
                                <option value="Ютуб-шоу">Ютуб-шоу</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Превью</th>
                                    <th>Артист</th>
                                    <th>Название</th>
                                    <th>Тип</th>
                                    <th>Порядок</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="videosTableBody">
                                <!-- Данные будут добавлены через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Таблица фотоальбомов -->
            <div class="tab-content" id="photo-albums-tab">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Управление фотоальбомами</h2>
                    <button class="admin-btn btn-primary" onclick="openPhotoAlbumModal()">
                        <i class="fas fa-plus mr-2"></i> Добавить альбом
                    </button>
                </div>
                
                <div class="admin-card">
                    <div class="flex justify-between items-center mb-4">
                        <div class="relative w-64">
                            <input type="text" id="albumSearch" placeholder="Поиск альбомов..." class="admin-form-input">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <div>
                            <select id="albumTypeFilter" class="admin-form-input w-auto">
                                <option value="">Все типы</option>
                                <option value="Кампейн">Кампейн</option>
                                <option value="Каталог">Каталог</option>
                                <option value="Промо к релизу">Промо к релизу</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Превью</th>
                                    <th>Артист</th>
                                    <th>Название</th>
                                    <th>Тип</th>
                                    <th>Изображений</th>
                                    <th>Порядок</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="photoAlbumsTableBody">
                                <!-- Данные будут добавлены через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Статистика -->
            <div class="tab-content" id="stats-tab">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold">Статистика платформы</h2>
                </div>
                
                <div class="admin-card">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Левая колонка с основными показателями -->
                        <div class="space-y-6">
                            <div class="bg-gradient-to-br from-blue-500/10 to-blue-600/10 rounded-xl p-6 border border-blue-500/20">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <div class="bg-blue-500/20 p-3 rounded-lg mr-4">
                                            <i class="fas fa-users text-blue-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="text-gray-400 text-sm uppercase tracking-wider">Всего пользователей</div>
                                            <div class="text-3xl font-bold mt-1" id="totalUsers">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-green-500/10 to-green-600/10 rounded-xl p-6 border border-green-500/20">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center">
                                        <div class="bg-green-500/20 p-3 rounded-lg mr-4">
                                            <i class="fas fa-graduation-cap text-green-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="text-gray-400 text-sm uppercase tracking-wider">Средний прогресс</div>
                                            <div class="text-3xl font-bold mt-1" id="avgProgress">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Правая колонка с диаграммой -->
                        <div class="bg-gradient-to-br from-purple-500/10 to-purple-600/10 rounded-xl p-6 border border-purple-500/20">
                            <div class="flex items-center mb-6">
                                <div class="bg-purple-500/20 p-3 rounded-lg mr-4">
                                    <i class="fas fa-chart-pie text-purple-400 text-xl"></i>
                                </div>
                                <div>
                                    <div class="text-gray-400 text-sm uppercase tracking-wider">Распределение ролей</div>
                                </div>
                            </div>
                            <div class="h-64">
                                <canvas id="rolesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer (сохранен из оригинального кода) -->
        <footer class="py-16 px-4 md:px-12 lg:px-24 animate-fade-in animate-delay-3">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-center mb-16">
                    <div class="flex items-center gap-4 gothic-font">
                        <span class="text-6xl font-normal opacity-50 cursor-pointer" id="loginBtnFooter">ВХОД /</span>
                        <span class="text-6xl font-normal cursor-pointer" id="registerBtnFooter">РЕГИСТРАЦИЯ</span>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-2/5 mb-12 md:mb-0">
                        <h3 class="font-bold text-lg mb-4">О нас</h3>
                        <p class="text-lg">
                            Artel production – фото и видео продакшн полного цикла. Работаем в Москве, Санкт-Петербурге и по всему миру.
                        </p>
                    </div>
                    
                    <div class="md:w-2/5 mb-12 md:mb-0 md:px-8">
                        <h3 class="font-bold text-lg mb-4">Быстрые ссылки</h3>
                        <div class="flex flex-col gap-2">
                            <a href="/index.html" class="text-lg hover:text-gray-300 transition">Главная</a>
                            <a href="#" class="text-lg hover:text-gray-300 transition" onclick="openPrivacyPopup()">Политика конфиденциальности</a>
                            <a href="/Portfolio-video.html" class="text-lg hover:text-gray-300 transition">Видео работы</a>
                            <a href="/Portfolio-photo.html" class="text-lg hover:text-gray-300 transition">Фото работы</a>
                            <a href="/Uslugi.html" class="text-lg hover:text-gray-300 transition">Услуги</a>
                            <a href="/Blog-news.html" class="text-lg hover:text-gray-300 transition">Блог</a>
                            <a href="/Kurs-info.html" class="text-lg hover:text-gray-300 transition">Курс</a>
                        </div>
                    </div>
                    
                    <div class="md:w-1/5">
                        <h3 class="font-bold text-lg mb-4">Контакты</h3>
                        <div class="mb-6">
                            <div class="flex items-center">
                                <i class="fas fa-envelope mr-2"></i>
                                <span class="text-lg">info@artel.ru</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <a href="https://t.me/pagezarok" class="text-white hover:text-blue-400 transition">
                                <i class="fab fa-telegram text-2xl"></i>
                            </a>
                            <a href="https://wa.me/79806782093?text=%D0%97%D0%B4%D1%80%D0%B0%D0%B2%D1%81%D1%82%D0%B2%D1%83%D0%B9%D1%82%D0%B5!%20%F0%9F%91%8B%20%D0%AF%20%D1%85%D0%BE%D1%87%D1%83%20%D1%81%D0%B4%D0%B5%D0%BB%D0%B0%D1%82%D1%8C%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7..." class="text-white hover:text-green-400 transition">
                                <i class="fab fa-whatsapp text-2xl"></i>
                            </a>
                            <a href="https://vk.com/zarok485prod" class="text-white hover:text-green-400 transition">
                                <i class="fab fa-vk text-2xl"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Проверка авторизации при загрузке страницы
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // ========== ИНИЦИАЛИЗАЦИЯ ==========
            // Загружаем данные, если открыта вкладка пользователей
            console.log('Начало инициализации...');
            
            // Проверяем, что пользователь - администратор
            async function checkAdminStatus() {
                try {
                    console.log('Проверка прав администратора...');
                    const response = await fetch('/users/me/', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка авторизации');
                    }
                    
                    const userData = await response.json();
                    console.log('Данные пользователя:', userData);
                    
                    // Если пользователь не админ, перенаправляем на главную
                    if (userData.is_admin !== 1) {
                        alert('У вас нет прав для доступа к этой странице');
                        window.location.href = '/index.html';
                        return;
                    }
                    
                    // Если все проверки пройдены, загружаем данные
                    console.log('Загрузка данных пользователей...');
                    await loadUsers();
                } catch (error) {
                    console.error('Ошибка проверки прав:', error);
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            }

            // Вызываем проверку прав администратора
            checkAdminStatus();

            // Элементы интерфейса
            const tabs = document.querySelectorAll('.admin-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const addUserModal = document.getElementById('addUserModal');
            const addUserBtn = document.querySelector('#users-tab .btn-primary');
            const closeModalBtn = document.getElementById('closeModal');
            const cancelAddUserBtn = document.getElementById('cancelAddUser');
            const addUserForm = document.getElementById('addUserForm');
            const accordionHeaders = document.querySelectorAll('.admin-card .border-gray-700 .bg-gray-800');

            // ========== ОБРАБОТКА ВКЛАДОК ==========
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Переключение активной вкладки
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Загрузка данных при открытии вкладки
                    if (tabId === 'users') loadUsers();
                    if (tabId === 'videos') loadVideos();
                    if (tabId === 'photo-albums') loadPhotoAlbums();
                    if (tabId === 'stats') loadStats();
                });
            });

            // ========== ЗАГРУЗКА ПОЛЬЗОВАТЕЛЕЙ ==========
            async function loadUsers() {
                console.log('Функция loadUsers вызвана');
                try {
                    // Показываем индикатор загрузки
                    const table = document.querySelector('#users-tab table');
                    console.log('Таблица найдена:', !!table);
                    
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Фамилия</th>
                                <th>Логин</th>
                                <th>Прогресс</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Загрузка данных...
                                </td>
                            </tr>
                        </tbody>
                    `;

                    console.log('Отправка запроса к /admin/users/');
                    const response = await fetch('/admin/users/', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    console.log('Получен ответ:', response.status);
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error('Недостаточно прав для доступа');
                        } else if (response.status === 401) {
                            throw new Error('Требуется авторизация');
                        } else {
                            throw new Error(`Ошибка: ${response.status}`);
                        }
                    }
                    
                    const data = await response.json();
                    console.log('Полученные данные:', data);
                    
                    if (!data.users || !Array.isArray(data.users)) {
                        throw new Error('Неверный формат данных');
                    }

                    // Отладочный вывод для каждого пользователя
                    data.users.forEach(user => {
                        console.log('Пользователь:', {
                            id: user.id,
                            username: user.username,
                            is_admin: user.is_admin,
                            is_admin_type: typeof user.is_admin
                        });
                    });
                    
                    renderUsersTable(data.users);
                } catch (error) {
                    console.error('Ошибка загрузки:', error);
                    const errorMessage = error.message;
                    
                    document.querySelector('#users-tab table tbody').innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4 text-red-500">
                                ${errorMessage}
                            </td>
                        </tr>
                    `;
                    
                    if (error.message === 'Требуется авторизация' || error.message === 'Недостаточно прав для доступа') {
                        setTimeout(() => {
                            localStorage.removeItem('token');
                            window.location.href = '/login.html';
                        }, 1500);
                    }
                }
            }

            // Функции для редактирования и удаления пользователей
            async function editUser(userId) {
                try {
                    const response = await fetch(`/users/${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка получения данных пользователя');
                    }
                    
                    const userData = await response.json();
                    
                    // Заполняем форму данными пользователя
                    document.getElementById('firstName').value = userData.first_name || '';
                    document.getElementById('lastName').value = userData.last_name || '';
                    document.getElementById('username').value = userData.username;
                    document.getElementById('password').value = ''; // Очищаем пароль
                    
                    // Показываем модальное окно
                    addUserModal.classList.remove('hidden');
                    
                    // Добавляем ID пользователя в форму для последующего обновления
                    addUserForm.dataset.userId = userId;
                    
                    // Меняем заголовок и текст кнопки
                    document.querySelector('#addUserModal h3').textContent = 'Редактировать пользователя';
                    addUserForm.querySelector('button[type="submit"]').textContent = 'Сохранить';
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при получении данных пользователя');
                }
            }

            async function deleteUser(userId) {
                if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка удаления пользователя');
                    }
                    
                    alert('Пользователь успешно удален');
                    loadUsers(); // Обновляем таблицу
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при удалении пользователя');
                }
            }

            // Функция для изменения прав администратора
            async function toggleAdmin(userId, currentStatus) {
                try {
                    const response = await fetch(`/users/${userId}/toggle-admin`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            is_admin: !currentStatus
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка изменения прав администратора');
                    }
                    
                    alert(`Права администратора ${!currentStatus ? 'выданы' : 'отозваны'}`);
                    loadUsers(); // Обновляем таблицу
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при изменении прав администратора');
                }
            }

            function renderUsersTable(users) {
                const tbody = document.createElement('tbody');
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">Нет данных о пользователях</td>
                        </tr>
                    `;
                } else {
                    users.forEach(user => {
                        // Преобразуем is_admin в булево значение
                        const isAdmin = user.is_admin === 1 || user.is_admin === true;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.first_name || '-'}</td>
                            <td>${user.last_name || '-'}</td>
                            <td>${user.username}</td>
                            <td>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" 
                                        style="width: ${user.progress || 0}%"></div>
                                </div>
                                <span class="text-sm">${user.progress || 0}%</span>
                            </td>
                            <td>${user.date_reg || 'Не указана'}</td>
                            <td>
                                <div class="flex gap-2">
                                    <button class="admin-btn btn-primary edit-user" data-user-id="${user.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${isAdmin ? 
                                        `<button class="admin-btn btn-danger toggle-admin" 
                                                data-user-id="${user.id}" 
                                                data-is-admin="true"
                                                title="Снять права администратора">
                                            <i class="fas fa-user-minus"></i>
                                        </button>` :
                                        `<button class="admin-btn btn-success toggle-admin" 
                                                data-user-id="${user.id}" 
                                                data-is-admin="false"
                                                title="Назначить администратором">
                                            <i class="fas fa-user-shield"></i>
                                        </button>`
                                    }
                                    <button class="admin-btn btn-danger delete-user" data-user-id="${user.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Добавляем обработчики событий для кнопок
                    tbody.querySelectorAll('.edit-user').forEach(button => {
                        button.addEventListener('click', () => {
                            const userId = button.dataset.userId;
                            editUser(userId);
                        });
                    });

                    tbody.querySelectorAll('.toggle-admin').forEach(button => {
                        button.addEventListener('click', () => {
                            const userId = button.dataset.userId;
                            const isAdmin = button.dataset.isAdmin === 'true';
                            if (confirm(isAdmin ? 
                                'Вы уверены, что хотите снять права администратора?' : 
                                'Вы уверены, что хотите назначить пользователя администратором?')) {
                                toggleAdmin(userId, isAdmin);
                            }
                        });
                    });

                    tbody.querySelectorAll('.delete-user').forEach(button => {
                        button.addEventListener('click', () => {
                            const userId = button.dataset.userId;
                            deleteUser(userId);
                        });
                    });
                }

                const table = document.querySelector('#users-tab table');
                const oldTbody = table.querySelector('tbody');
                if (oldTbody) table.removeChild(oldTbody);
                table.appendChild(tbody);
            }

            // ========== МОДАЛЬНОЕ ОКНО ДОБАВЛЕНИЯ ПОЛЬЗОВАТЕЛЯ ==========
            // Открытие модального окна
            addUserBtn.addEventListener('click', () => {
                // Сбрасываем форму и заголовок
                addUserForm.reset();
                delete addUserForm.dataset.userId;
                document.querySelector('#addUserModal h3').textContent = 'Добавить пользователя';
                addUserForm.querySelector('button[type="submit"]').textContent = 'Добавить';
                addUserModal.classList.remove('hidden');
            });

            // Закрытие модального окна
            closeModalBtn.addEventListener('click', () => {
                closeModal();
            });

            cancelAddUserBtn.addEventListener('click', () => {
                closeModal();
            });

            // Закрытие по клику вне модального окна
            addUserModal.addEventListener('click', (e) => {
                if (e.target === addUserModal) {
                    closeModal();
                }
            });

            // Функция закрытия модального окна
            function closeModal() {
                addUserModal.classList.add('hidden');
                addUserForm.reset();
                delete addUserForm.dataset.userId;
                document.querySelector('#addUserModal h3').textContent = 'Добавить пользователя';
                addUserForm.querySelector('button[type="submit"]').textContent = 'Добавить';
            }

            // Обработчик отправки формы
            addUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = addUserForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';

                const userData = {
                    first_name: document.getElementById('firstName').value,
                    last_name: document.getElementById('lastName').value,
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value
                };

                try {
                    // Валидация
                    if (!userData.first_name || !userData.username) {
                        throw new Error('Заполните все обязательные поля');
                    }

                    if (userData.password && userData.password.length < 6) {
                        throw new Error('Пароль должен быть не менее 6 символов');
                    }

                    const userId = addUserForm.dataset.userId;
                    const isEdit = !!userId;
                    
                    // Определяем URL и метод в зависимости от того, это создание или редактирование
                    const url = isEdit ? `/users/${userId}` : '/register/';
                    const method = isEdit ? 'PUT' : 'POST';
                    
                    // Если это редактирование и пароль не указан, удаляем его из данных
                    if (isEdit && !userData.password) {
                        delete userData.password;
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(userData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Ошибка сервера');
                    }

                    // Успешное создание/обновление
                    alert(`Пользователь успешно ${isEdit ? 'обновлен' : 'добавлен'}!`);
                    closeModal();
                    loadUsers(); // Обновляем таблицу
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert(error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = addUserForm.dataset.userId ? 'Сохранить' : 'Добавить';
                }
            });

            // ========== АККОРДЕОН УРОКОВ ==========
            accordionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const icon = this.querySelector('i');
                    const content = this.nextElementSibling;
                    icon.classList.toggle('rotate-180');
                    content.classList.toggle('hidden');
                });
            });

            // ========== ЗАГРУЗКА СТАТИСТИКИ ==========
            let rolesChart = null; // Глобальная переменная для хранения экземпляра диаграммы

            async function loadStats() {
                try {
                    const response = await fetch('/admin/stats/', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка получения статистики');
                    }
                    
                    const data = await response.json();
                    
                    // Обновляем карточки статистики
                    document.getElementById('totalUsers').textContent = data.total_users;
                    document.getElementById('avgProgress').textContent = `${data.avg_progress}%`;
                    
                    // Удаляем старую диаграмму, если она существует
                    if (rolesChart) {
                        rolesChart.destroy();
                    }
                    
                    // Создаем круговую диаграмму распределения ролей
                    rolesChart = new Chart(document.getElementById('rolesChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Обычные пользователи', 'Администраторы'],
                            datasets: [{
                                data: [data.regular_users, data.admin_count],
                                backgroundColor: [
                                    '#3B82F6', // синий для обычных пользователей
                                    '#10B981'  // зеленый для администраторов
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#9CA3AF',
                                        padding: 20,
                                        font: {
                                            size: 14,
                                            family: "'Inter', sans-serif"
                                        }
                                    }
                                }
                            },
                            cutout: '75%',
                            animation: {
                                animateScale: true,
                                animateRotate: true
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('Ошибка загрузки статистики:', error);
                    alert('Ошибка при загрузке статистики');
                }
            }

            // ========== УПРАВЛЕНИЕ ВИДЕО ==========
            let videos = [];
            let currentVideoId = null;

            // Загрузка видео при открытии вкладки
            async function loadVideos() {
                try {
                    const response = await fetch('/videos/');
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки видео');
                    }
                    
                    const data = await response.json();
                    videos = data.videos;
                    renderVideosTable(videos);
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при загрузке видео');
                }
            }

            // Отрисовка таблицы видео
            function renderVideosTable(videosToRender) {
                const tbody = document.getElementById('videosTableBody');
                tbody.innerHTML = '';
                
                videosToRender.forEach(video => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${video.id}</td>
                        <td>
                            <img src="${video.thumbnail_url}" alt="${video.title}" 
                                 class="w-20 h-12 object-cover rounded cursor-pointer"
                                 onclick="openVideoModal('${video.youtube_url}', ${videos.indexOf(video)})">
                        </td>
                        <td>${video.artist}</td>
                        <td>${video.title}</td>
                        <td>${video.type}</td>
                        <td>${video.order}</td>
                        <td>
                            <div class="flex gap-2">
                                <button class="admin-btn btn-primary" onclick="editVideo(${video.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="admin-btn btn-danger" onclick="deleteVideo(${video.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Открытие модального окна для добавления/редактирования
            function openVideoModal(videoId = null) {
                currentVideoId = videoId;
                const modal = document.getElementById('videoModal');
                const form = document.getElementById('videoForm');
                const title = document.querySelector('#videoModal h3');
                
                // Сброс формы
                form.reset();
                removeThumbnail(); // Сбрасываем превью
                
                if (videoId) {
                    // Редактирование существующего видео
                    const video = videos.find(v => v.id === videoId);
                    if (video) {
                        document.getElementById('videoArtist').value = video.artist;
                        document.getElementById('videoTitle').value = video.title;
                        document.getElementById('videoType').value = video.type;
                        document.getElementById('videoYoutubeUrl').value = video.youtube_url;
                        document.getElementById('videoOrder').value = video.order;
                        title.textContent = 'Редактировать видео';
                    }
                } else {
                    title.textContent = 'Добавить видео';
                }
                
                modal.classList.remove('hidden');
            }

            // Обработка отправки формы видео
            document.getElementById('videoForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';

                try {
                    let thumbnailUrl = '';
                    
                    // Если есть новый файл, загружаем его
                    if (currentThumbnailFile) {
                        const formData = new FormData();
                        formData.append('file', currentThumbnailFile);
                        
                        const uploadResponse = await fetch('/upload-thumbnail/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            throw new Error('Ошибка загрузки превью');
                        }
                        
                        const uploadResult = await uploadResponse.json();
                        thumbnailUrl = uploadResult.url;
                    }

                    const videoData = {
                        artist: document.getElementById('videoArtist').value,
                        title: document.getElementById('videoTitle').value,
                        type: document.getElementById('videoType').value,
                        youtube_url: document.getElementById('videoYoutubeUrl').value,
                        thumbnail_url: thumbnailUrl,
                        order: parseInt(document.getElementById('videoOrder').value)
                    };

                    const url = currentVideoId ? `/videos/${currentVideoId}` : '/videos/';
                    const method = currentVideoId ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(videoData)
                    });

                    if (!response.ok) {
                        throw new Error('Ошибка сохранения видео');
                    }

                    alert(`Видео успешно ${currentVideoId ? 'обновлено' : 'добавлено'}`);
                    closeVideoModal();
                    loadVideos();
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert(error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = currentVideoId ? 'Сохранить' : 'Добавить';
                }
            });

            function closeVideoModal() {
                const modal = document.getElementById('videoModal');
                modal.classList.add('hidden');
                currentVideoId = null;
                removeThumbnail(); // Сбрасываем превью при закрытии
            }

            // Удаление видео
            async function deleteVideo(videoId) {
                if (!confirm('Вы уверены, что хотите удалить это видео?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/videos/${videoId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка удаления видео');
                    }
                    
                    alert('Видео успешно удалено');
                    loadVideos();
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при удалении видео');
                }
            }

            // Редактирование видео
            function editVideo(videoId) {
                openVideoModal(videoId);
            }

            // Поиск и фильтрация видео
            document.getElementById('videoSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const typeFilter = document.getElementById('videoTypeFilter').value;
                
                const filteredVideos = videos.filter(video => {
                    const matchesSearch = video.title.toLowerCase().includes(searchTerm) ||
                                        video.artist.toLowerCase().includes(searchTerm);
                    const matchesType = !typeFilter || video.type === typeFilter;
                    return matchesSearch && matchesType;
                });
                
                renderVideosTable(filteredVideos);
            });

            document.getElementById('videoTypeFilter').addEventListener('change', function(e) {
                const searchTerm = document.getElementById('videoSearch').value.toLowerCase();
                const typeFilter = e.target.value;
                
                const filteredVideos = videos.filter(video => {
                    const matchesSearch = video.title.toLowerCase().includes(searchTerm) ||
                                        video.artist.toLowerCase().includes(searchTerm);
                    const matchesType = !typeFilter || video.type === typeFilter;
                    return matchesSearch && matchesType;
                });
                
                renderVideosTable(filteredVideos);
            });

            // Делаем функции глобально доступными
            window.editVideo = async function(videoId) {
                try {
                    const response = await fetch(`/videos/${videoId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка получения данных видео');
                    }
                    
                    const video = await response.json();
                    openVideoModal(videoId);
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при получении данных видео');
                }
            };

            window.deleteVideo = async function(videoId) {
                if (!confirm('Вы уверены, что хотите удалить это видео?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/videos/${videoId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка удаления видео');
                    }
                    
                    alert('Видео успешно удалено');
                    loadVideos();
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при удалении видео');
                }
            };

            window.openVideoModal = function(videoId = null) {
                currentVideoId = videoId;
                const modal = document.getElementById('videoModal');
                const form = document.getElementById('videoForm');
                const title = document.querySelector('#videoModal h3');
                
                // Сброс формы
                form.reset();
                removeThumbnail(); // Сбрасываем превью
                
                if (videoId) {
                    // Редактирование существующего видео
                    const video = videos.find(v => v.id === videoId);
                    if (video) {
                        document.getElementById('videoArtist').value = video.artist;
                        document.getElementById('videoTitle').value = video.title;
                        document.getElementById('videoType').value = video.type;
                        document.getElementById('videoYoutubeUrl').value = video.youtube_url;
                        document.getElementById('videoOrder').value = video.order;
                        title.textContent = 'Редактировать видео';
                    }
                } else {
                    title.textContent = 'Добавить видео';
                }
                
                modal.classList.remove('hidden');
            };

            window.closeVideoModal = function() {
                const modal = document.getElementById('videoModal');
                modal.classList.add('hidden');
                currentVideoId = null;
                removeThumbnail(); // Сбрасываем превью при закрытии
            };

            window.removeThumbnail = function() {
                currentThumbnailFile = null;
                thumbnailPreview.classList.add('hidden');
                thumbnailInput.value = '';
            };

            // Обработка drag and drop для превью
            const dropZone = document.getElementById('thumbnailDropZone');
            const thumbnailInput = document.getElementById('thumbnailInput');
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            let currentThumbnailFile = null;

            // Предотвращаем стандартное поведение браузера
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Добавляем визуальные эффекты при перетаскивании
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                dropZone.classList.add('border-blue-500');
            }

            function unhighlight(e) {
                dropZone.classList.remove('border-blue-500');
            }

            // Обработка загрузки файла
            dropZone.addEventListener('drop', handleDrop, false);
            thumbnailInput.addEventListener('change', handleFileSelect, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }

            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.match('image.*')) {
                        currentThumbnailFile = file;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            thumbnailPreview.querySelector('img').src = e.target.result;
                            thumbnailPreview.classList.remove('hidden');
                        }
                        reader.readAsDataURL(file);
                    } else {
                        alert('Пожалуйста, загрузите изображение в формате JPG или PNG');
                    }
                }
            }

            // ========== УПРАВЛЕНИЕ ФОТОАЛЬБОМАМИ ==========
            let photoAlbums = [];
            let currentAlbumId = null;
            let currentPreviewFile = null;
            let currentAlbumImages = [];

            // Загрузка фотоальбомов при открытии вкладки
            async function loadPhotoAlbums() {
                try {
                    const response = await fetch('/photo-albums/');
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки фотоальбомов');
                    }
                    
                    const data = await response.json();
                    photoAlbums = data;
                    renderPhotoAlbumsTable(photoAlbums);
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при загрузке фотоальбомов');
                }
            }

            // Отрисовка таблицы фотоальбомов
            function renderPhotoAlbumsTable(albumsToRender) {
                const tbody = document.getElementById('photoAlbumsTableBody');
                tbody.innerHTML = '';
                
                if (albumsToRender.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">Нет данных о фотоальбомах</td>
                        </tr>
                    `;
                    return;
                }
                
                albumsToRender.forEach(album => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${album.id}</td>
                        <td>
                            <img src="${album.preview_url}" alt="${album.title}" 
                                 class="w-20 h-12 object-cover rounded cursor-pointer"
                                 onclick="openPhotoAlbumModal(${album.id})">
                        </td>
                        <td>${album.artist}</td>
                        <td>${album.title}</td>
                        <td>${album.type}</td>
                        <td>${album.images ? album.images.length : 0}</td>
                        <td>${album.order}</td>
                        <td>
                            <div class="flex gap-2">
                                <button class="admin-btn btn-primary" onclick="editPhotoAlbum(${album.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="admin-btn btn-danger" onclick="deletePhotoAlbum(${album.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Открытие модального окна для добавления/редактирования
            function openPhotoAlbumModal(albumId = null) {
                currentAlbumId = albumId;
                const modal = document.getElementById('photoAlbumModal');
                const form = document.getElementById('photoAlbumForm');
                const title = document.querySelector('#photoAlbumModal h3');
                
                // Сброс формы
                form.reset();
                removePreviewImage();
                removeAlbumImages();
                
                if (albumId) {
                    // Редактирование существующего альбома
                    const album = photoAlbums.find(a => a.id === albumId);
                    if (album) {
                        document.getElementById('albumArtist').value = album.artist;
                        document.getElementById('albumTitle').value = album.title;
                        document.getElementById('albumType').value = album.type;
                        document.getElementById('albumOrder').value = album.order;
                        title.textContent = 'Редактировать фотоальбом';
                        
                        // Показываем существующее превью
                        if (album.preview_url) {
                            const previewImg = document.querySelector('#previewImagePreview img');
                            previewImg.src = album.preview_url;
                            document.getElementById('previewImagePreview').classList.remove('hidden');
                        }
                        
                        // Показываем существующие изображения
                        if (album.images && album.images.length > 0) {
                            const imagesPreview = document.getElementById('imagesPreview');
                            imagesPreview.innerHTML = '';
                            album.images.forEach(image => {
                                const imgDiv = document.createElement('div');
                                imgDiv.className = 'relative';
                                imgDiv.innerHTML = `
                                    <img src="${image.url}" alt="Изображение" class="w-full h-24 object-cover rounded">
                                    <button type="button" onclick="removeAlbumImage('${image.url}')" 
                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                                imagesPreview.appendChild(imgDiv);
                            });
                            imagesPreview.classList.remove('hidden');
                        }
                    }
                } else {
                    title.textContent = 'Добавить фотоальбом';
                }
                
                modal.classList.remove('hidden');
            }

            // Обработка отправки формы фотоальбома
            document.getElementById('photoAlbumForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';

                try {
                    let previewUrl = '';
                    
                    // Если есть новый файл превью, загружаем его
                    if (currentPreviewFile) {
                        const formData = new FormData();
                        formData.append('file', currentPreviewFile);
                        
                        const uploadResponse = await fetch('/upload-preview/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            throw new Error('Ошибка загрузки превью');
                        }
                        
                        const uploadResult = await uploadResponse.json();
                        previewUrl = uploadResult.url;
                    }

                    // Загружаем новые изображения альбома
                    const imageUrls = [];
                    for (const file of currentAlbumImages) {
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        const uploadResponse = await fetch('/upload-image/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            throw new Error('Ошибка загрузки изображения');
                        }
                        
                        const uploadResult = await uploadResponse.json();
                        imageUrls.push(uploadResult.url);
                    }

                    const albumData = {
                        artist: document.getElementById('albumArtist').value,
                        title: document.getElementById('albumTitle').value,
                        type: document.getElementById('albumType').value,
                        preview_url: previewUrl,
                        image_urls: imageUrls,
                        order: parseInt(document.getElementById('albumOrder').value)
                    };

                    const url = currentAlbumId ? `/photo-albums/${currentAlbumId}` : '/photo-albums/';
                    const method = currentAlbumId ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(albumData)
                    });

                    if (!response.ok) {
                        throw new Error('Ошибка сохранения фотоальбома');
                    }

                    alert(`Фотоальбом успешно ${currentAlbumId ? 'обновлен' : 'добавлен'}`);
                    closePhotoAlbumModal();
                    loadPhotoAlbums();
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert(error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = currentAlbumId ? 'Сохранить' : 'Добавить';
                }
            });

            function closePhotoAlbumModal() {
                const modal = document.getElementById('photoAlbumModal');
                modal.classList.add('hidden');
                currentAlbumId = null;
                removePreviewImage();
                removeAlbumImages();
            }

            // Удаление фотоальбома
            async function deletePhotoAlbum(albumId) {
                if (!confirm('Вы уверены, что хотите удалить этот фотоальбом?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/photo-albums/${albumId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка удаления фотоальбома');
                    }
                    
                    alert('Фотоальбом успешно удален');
                    loadPhotoAlbums();
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при удалении фотоальбома');
                }
            }

            // Редактирование фотоальбома
            function editPhotoAlbum(albumId) {
                openPhotoAlbumModal(albumId);
            }

            // Поиск и фильтрация фотоальбомов
            document.getElementById('albumSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const typeFilter = document.getElementById('albumTypeFilter').value;
                
                const filteredAlbums = photoAlbums.filter(album => {
                    const matchesSearch = album.title.toLowerCase().includes(searchTerm) ||
                                        album.artist.toLowerCase().includes(searchTerm);
                    const matchesType = !typeFilter || album.type === typeFilter;
                    return matchesSearch && matchesType;
                });
                
                renderPhotoAlbumsTable(filteredAlbums);
            });

            document.getElementById('albumTypeFilter').addEventListener('change', function(e) {
                const searchTerm = document.getElementById('albumSearch').value.toLowerCase();
                const typeFilter = e.target.value;
                
                const filteredAlbums = photoAlbums.filter(album => {
                    const matchesSearch = album.title.toLowerCase().includes(searchTerm) ||
                                        album.artist.toLowerCase().includes(searchTerm);
                    const matchesType = !typeFilter || album.type === typeFilter;
                    return matchesSearch && matchesType;
                });
                
                renderPhotoAlbumsTable(filteredAlbums);
            });

            // Функции для работы с превью изображением
            function removePreviewImage() {
                currentPreviewFile = null;
                document.getElementById('previewImagePreview').classList.add('hidden');
                document.getElementById('previewInput').value = '';
            }

            function removeAlbumImages() {
                currentAlbumImages = [];
                document.getElementById('imagesPreview').classList.add('hidden');
                document.getElementById('imagesPreview').innerHTML = '';
                document.getElementById('imagesInput').value = '';
            }

            function removeAlbumImage(imageUrl) {
                // Удаляем изображение из превью
                const imagesPreview = document.getElementById('imagesPreview');
                const imageDivs = imagesPreview.querySelectorAll('div');
                imageDivs.forEach(div => {
                    const img = div.querySelector('img');
                    if (img.src.includes(imageUrl)) {
                        div.remove();
                    }
                });
                
                // Если нет изображений, скрываем контейнер
                if (imagesPreview.children.length === 0) {
                    imagesPreview.classList.add('hidden');
                }
            }

            // Обработка drag and drop для превью
            const previewDropZone = document.getElementById('previewDropZone');
            const previewInput = document.getElementById('previewInput');
            const previewImagePreview = document.getElementById('previewImagePreview');

            // Предотвращаем стандартное поведение браузера
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                previewDropZone.addEventListener(eventName, preventDefaults, false);
            });

            // Добавляем визуальные эффекты при перетаскивании
            ['dragenter', 'dragover'].forEach(eventName => {
                previewDropZone.addEventListener(eventName, () => {
                    previewDropZone.classList.add('border-blue-500');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                previewDropZone.addEventListener(eventName, () => {
                    previewDropZone.classList.remove('border-blue-500');
                }, false);
            });

            // Обработка загрузки файла превью
            previewDropZone.addEventListener('drop', handlePreviewDrop, false);
            previewInput.addEventListener('change', handlePreviewFileSelect, false);

            function handlePreviewDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handlePreviewFiles(files);
            }

            function handlePreviewFileSelect(e) {
                const files = e.target.files;
                handlePreviewFiles(files);
            }

            function handlePreviewFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.match('image.*')) {
                        currentPreviewFile = file;
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImagePreview.querySelector('img').src = e.target.result;
                            previewImagePreview.classList.remove('hidden');
                        }
                        reader.readAsDataURL(file);
                    } else {
                        alert('Пожалуйста, загрузите изображение в формате JPG или PNG');
                    }
                }
            }

            // Обработка drag and drop для изображений альбома
            const imagesDropZone = document.getElementById('imagesDropZone');
            const imagesInput = document.getElementById('imagesInput');
            const imagesPreview = document.getElementById('imagesPreview');

            // Предотвращаем стандартное поведение браузера
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imagesDropZone.addEventListener(eventName, preventDefaults, false);
            });

            // Добавляем визуальные эффекты при перетаскивании
            ['dragenter', 'dragover'].forEach(eventName => {
                imagesDropZone.addEventListener(eventName, () => {
                    imagesDropZone.classList.add('border-blue-500');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                imagesDropZone.addEventListener(eventName, () => {
                    imagesDropZone.classList.remove('border-blue-500');
                }, false);
            });

            // Обработка загрузки файлов изображений
            imagesDropZone.addEventListener('drop', handleImagesDrop, false);
            imagesInput.addEventListener('change', handleImagesFileSelect, false);

            function handleImagesDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleImagesFiles(files);
            }

            function handleImagesFileSelect(e) {
                const files = e.target.files;
                handleImagesFiles(files);
            }

            function handleImagesFiles(files) {
                Array.from(files).forEach(file => {
                    if (file.type.match('image.*')) {
                        currentAlbumImages.push(file);
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'relative';
                            imgDiv.innerHTML = `
                                <img src="${e.target.result}" alt="Изображение" class="w-full h-24 object-cover rounded">
                                <button type="button" onclick="removeAlbumImageFromPreview(this)" 
                                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            imagesPreview.appendChild(imgDiv);
                            imagesPreview.classList.remove('hidden');
                        }
                        reader.readAsDataURL(file);
                    } else {
                        alert('Пожалуйста, загрузите изображения в формате JPG, PNG или WEBP');
                    }
                });
            }

            // Удаление изображения из превью при добавлении
            function removeAlbumImageFromPreview(button) {
                const imgDiv = button.parentElement;
                const img = imgDiv.querySelector('img');
                const index = currentAlbumImages.findIndex(file => {
                    // Находим индекс файла по src изображения
                    return true; // Упрощенная логика
                });
                
                if (index > -1) {
                    currentAlbumImages.splice(index, 1);
                }
                
                imgDiv.remove();
                
                // Если нет изображений, скрываем контейнер
                if (imagesPreview.children.length === 0) {
                    imagesPreview.classList.add('hidden');
                }
            }

            // Делаем функции глобально доступными
            window.editPhotoAlbum = function(albumId) {
                editPhotoAlbum(albumId);
            };

            window.deletePhotoAlbum = function(albumId) {
                deletePhotoAlbum(albumId);
            };

            window.openPhotoAlbumModal = function(albumId = null) {
                openPhotoAlbumModal(albumId);
            };

            window.closePhotoAlbumModal = function() {
                closePhotoAlbumModal();
            };

            window.removePreviewImage = function() {
                removePreviewImage();
            };

            window.removeAlbumImage = function(imageUrl) {
                removeAlbumImage(imageUrl);
            };

            window.removeAlbumImageFromPreview = function(button) {
                removeAlbumImageFromPreview(button);
            };
        });
    </script>
    <!-- Модальное окно добавления пользователя -->
<div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Добавить пользователя</h3>
            <button id="closeModal" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="addUserForm" class="space-y-4">
            <div>
                <label class="block text-gray-400 mb-2">Имя</label>
                <input type="text" id="firstName" class="admin-form-input" required>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Фамилия</label>
                <input type="text" id="lastName" class="admin-form-input" required>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Логин</label>
                <input type="text" id="username" class="admin-form-input" required>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Пароль</label>
                <input type="password" id="password" class="admin-form-input" required>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancelAddUser" class="admin-btn border border-gray-600">Отмена</button>
                <button type="submit" class="admin-btn btn-primary">Добавить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно добавления/редактирования видео -->
<div id="videoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Добавить видео</h3>
            <button onclick="closeVideoModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="videoForm" class="space-y-4">
            <div>
                <label class="block text-gray-400 mb-2">Артист</label>
                <input type="text" id="videoArtist" class="admin-form-input" required>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Название</label>
                <input type="text" id="videoTitle" class="admin-form-input" required>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Тип</label>
                <select id="videoType" class="admin-form-input" required>
                    <option value="Муд-видео">Муд-видео</option>
                    <option value="Сниппет">Сниппет</option>
                    <option value="Акустик-видео">Акустик-видео</option>
                    <option value="Подкаст">Подкаст</option>
                    <option value="Рекламный Reels">Рекламный Reels</option>
                    <option value="Ютуб-шоу">Ютуб-шоу</option>
                </select>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">YouTube URL</label>
                <input type="text" id="videoYoutubeUrl" class="admin-form-input" required>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">URL превью</label>
                <div id="thumbnailDropZone" class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-gray-500 transition-colors">
                    <div class="space-y-2">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                        <p class="text-gray-400">Перетащите изображение сюда или кликните для выбора</p>
                        <p class="text-sm text-gray-500">Поддерживаются форматы: JPG, PNG</p>
                    </div>
                    <input type="file" id="thumbnailInput" class="hidden" accept="image/jpeg,image/png">
                </div>
                <div id="thumbnailPreview" class="mt-2 hidden">
                    <img src="" alt="Превью" class="max-h-32 rounded">
                    <button type="button" onclick="removeThumbnail()" class="mt-2 text-red-500 hover:text-red-400">
                        <i class="fas fa-times"></i> Удалить
                    </button>
                </div>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Порядок</label>
                <input type="number" id="videoOrder" class="admin-form-input" required min="1">
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeVideoModal()" class="admin-btn border border-gray-600">Отмена</button>
                <button type="submit" class="admin-btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно добавления/редактирования фотоальбома -->
<div id="photoAlbumModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Добавить фотоальбом</h3>
            <button onclick="closePhotoAlbumModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="photoAlbumForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-400 mb-2">Артист</label>
                    <input type="text" id="albumArtist" class="admin-form-input" required>
                </div>
                
                <div>
                    <label class="block text-gray-400 mb-2">Название альбома</label>
                    <input type="text" id="albumTitle" class="admin-form-input" required>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-400 mb-2">Тип</label>
                    <select id="albumType" class="admin-form-input" required>
                        <option value="Кампейн">Кампейн</option>
                        <option value="Каталог">Каталог</option>
                        <option value="Промо к релизу">Промо к релизу</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-400 mb-2">Порядок</label>
                    <input type="number" id="albumOrder" class="admin-form-input" required min="1">
                </div>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Превью изображение</label>
                <div id="previewDropZone" class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-gray-500 transition-colors">
                    <div class="space-y-2">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                        <p class="text-gray-400">Перетащите превью изображение сюда или кликните для выбора</p>
                        <p class="text-sm text-gray-500">Поддерживаются форматы: JPG, PNG</p>
                    </div>
                    <input type="file" id="previewInput" class="hidden" accept="image/jpeg,image/png">
                </div>
                <div id="previewImagePreview" class="mt-2 hidden">
                    <img src="" alt="Превью" class="max-h-32 rounded">
                    <button type="button" onclick="removePreviewImage()" class="mt-2 text-red-500 hover:text-red-400">
                        <i class="fas fa-times"></i> Удалить
                    </button>
                </div>
            </div>
            
            <div>
                <label class="block text-gray-400 mb-2">Изображения альбома</label>
                <div id="imagesDropZone" class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-gray-500 transition-colors">
                    <div class="space-y-2">
                        <i class="fas fa-images text-3xl text-gray-400"></i>
                        <p class="text-gray-400">Перетащите изображения альбома сюда или кликните для выбора</p>
                        <p class="text-sm text-gray-500">Поддерживаются форматы: JPG, PNG, WEBP</p>
                    </div>
                    <input type="file" id="imagesInput" class="hidden" accept="image/jpeg,image/png,image/webp" multiple>
                </div>
                <div id="imagesPreview" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 hidden">
                    <!-- Превью изображений будет добавлено здесь -->
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closePhotoAlbumModal()" class="admin-btn border border-gray-600">Отмена</button>
                <button type="submit" class="admin-btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>
</body>
</html>